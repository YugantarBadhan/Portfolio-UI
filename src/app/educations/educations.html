<!-- Author: Yugantar Badhan -->

<section id="educations" class="educations-section">
  <div class="container">
    <!-- Section Header -->
    <div class="section-header">
      <h2 class="section-title">Education</h2>
    </div>

    <!-- Loading State -->
    <div
      *ngIf="isLoading()"
      class="loading-spinner"
      role="status"
      aria-label="Loading educations"
    >
      <div class="spinner"></div>
      <p>Loading educations...</p>
    </div>

    <!-- Education Form Modal - FIXED: No backdrop close -->
    <div
      *ngIf="showForm() && isAdmin()"
      class="modal-overlay"
      role="dialog"
      aria-modal="true"
      aria-labelledby="form-title"
    >
      <div class="education-form-container" (click)="$event.stopPropagation()">
        <div class="form-header">
          <h3 id="form-title">
            {{ editingId() ? "Edit Education" : "Add New Education" }}
          </h3>
          <button
            class="close-btn"
            (click)="closeForm()"
            aria-label="Close form"
            type="button"
          >
            ×
          </button>
        </div>

        <form
          [formGroup]="educationForm"
          (ngSubmit)="onSubmit()"
          class="education-form"
          novalidate
        >
          <div class="form-row">
            <div class="form-group">
              <label for="degree">Degree/Qualification *</label>
              <input
                type="text"
                id="degree"
                formControlName="degree"
                placeholder="e.g., Bachelor of Technology"
                aria-describedby="degree-error"
                [attr.aria-invalid]="
                  educationForm.get('degree')?.invalid &&
                  educationForm.get('degree')?.touched
                "
              />
              <div
                id="degree-error"
                *ngIf="
                  educationForm.get('degree')?.invalid &&
                  educationForm.get('degree')?.touched
                "
                class="error-message"
                role="alert"
              >
                Degree/Qualification is required
              </div>
            </div>

            <div class="form-group">
              <label for="field">Field of Study/Major *</label>
              <input
                type="text"
                id="field"
                formControlName="field"
                placeholder="e.g., Computer Science"
                aria-describedby="field-error"
                [attr.aria-invalid]="
                  educationForm.get('field')?.invalid &&
                  educationForm.get('field')?.touched
                "
              />
              <div
                id="field-error"
                *ngIf="
                  educationForm.get('field')?.invalid &&
                  educationForm.get('field')?.touched
                "
                class="error-message"
                role="alert"
              >
                Field of Study/Major is required
              </div>
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label for="university">University/Board *</label>
              <input
                type="text"
                id="university"
                formControlName="university"
                placeholder="e.g., Mumbai University"
                aria-describedby="university-error"
                [attr.aria-invalid]="
                  educationForm.get('university')?.invalid &&
                  educationForm.get('university')?.touched
                "
              />
              <div
                id="university-error"
                *ngIf="
                  educationForm.get('university')?.invalid &&
                  educationForm.get('university')?.touched
                "
                class="error-message"
                role="alert"
              >
                University/Board is required
              </div>
            </div>

            <div class="form-group">
              <label for="institute">Institute *</label>
              <input
                type="text"
                id="institute"
                formControlName="institute"
                placeholder="e.g., Indian Institute of Technology"
                aria-describedby="institute-error"
                [attr.aria-invalid]="
                  educationForm.get('institute')?.invalid &&
                  educationForm.get('institute')?.touched
                "
              />
              <div
                id="institute-error"
                *ngIf="
                  educationForm.get('institute')?.invalid &&
                  educationForm.get('institute')?.touched
                "
                class="error-message"
                role="alert"
              >
                Institute is required
              </div>
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label for="location">Location</label>
              <input
                type="text"
                id="location"
                formControlName="location"
                placeholder="e.g., Mumbai, India"
              />
            </div>

            <div class="form-group">
              <label for="educationType">Education Type *</label>
              <select
                id="educationType"
                formControlName="educationType"
                aria-describedby="educationType-error"
                [attr.aria-invalid]="
                  educationForm.get('educationType')?.invalid &&
                  educationForm.get('educationType')?.touched
                "
              >
                <option value="">Select Education Type</option>
                <option value="Full-time">Full-time</option>
                <option value="Part-time">Part-time</option>
                <option value="Distance Learning">Distance Learning</option>
                <option value="Online">Online</option>
                <option value="Evening">Evening</option>
                <option value="Weekend">Weekend</option>
              </select>
              <div
                id="educationType-error"
                *ngIf="
                  educationForm.get('educationType')?.invalid &&
                  educationForm.get('educationType')?.touched
                "
                class="error-message"
                role="alert"
              >
                Education type is required
              </div>
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label for="startDate">Start Date *</label>
              <input
                type="text"
                id="startDate"
                formControlName="startDate"
                placeholder="e.g., 2019 or Aug 2019"
                aria-describedby="startDate-error"
                [attr.aria-invalid]="
                  educationForm.get('startDate')?.invalid &&
                  educationForm.get('startDate')?.touched
                "
              />
              <div
                id="startDate-error"
                *ngIf="
                  educationForm.get('startDate')?.invalid &&
                  educationForm.get('startDate')?.touched
                "
                class="error-message"
                role="alert"
              >
                Start date is required
              </div>
            </div>

            <div class="form-group">
              <label for="endDate">End Date</label>
              <input
                type="text"
                id="endDate"
                formControlName="endDate"
                placeholder="e.g., 2023 or Dec 2023"
                [disabled]="educationForm.get('currentStudying')?.value"
                aria-describedby="endDate-error"
                [attr.aria-invalid]="
                  educationForm.get('endDate')?.invalid &&
                  educationForm.get('endDate')?.touched
                "
              />
              <div
                id="endDate-error"
                *ngIf="
                  educationForm.get('endDate')?.invalid &&
                  educationForm.get('endDate')?.touched
                "
                class="error-message"
                role="alert"
              >
                End date is required when not currently studying
              </div>
              <div class="checkbox-group">
                <input
                  type="checkbox"
                  id="currentStudying"
                  formControlName="currentStudying"
                />
                <label for="currentStudying">Currently Studying</label>
              </div>
            </div>
          </div>

          <div class="form-group">
            <label for="grade">Grade/CGPA/Percentage *</label>
            <input
              type="text"
              id="grade"
              formControlName="grade"
              placeholder="e.g., 8.6 CGPA or 85% or A+"
              aria-describedby="grade-error"
              [attr.aria-invalid]="
                educationForm.get('grade')?.invalid &&
                educationForm.get('grade')?.touched
              "
            />
            <div
              id="grade-error"
              *ngIf="
                educationForm.get('grade')?.invalid &&
                educationForm.get('grade')?.touched
              "
              class="error-message"
              role="alert"
            >
              Grade/CGPA/Percentage is required
            </div>
          </div>

          <div class="form-group full-width">
            <label for="description">Description</label>
            <textarea
              id="description"
              formControlName="description"
              placeholder="Describe your educational experience, key achievements, relevant coursework, projects, etc."
              rows="4"
            ></textarea>
          </div>

          <div class="form-actions">
            <button
              type="button"
              class="btn-cancel"
              (click)="closeForm()"
              aria-label="Cancel form"
            >
              Cancel
            </button>
            <button
              type="submit"
              class="btn-submit"
              [disabled]="!isFormValid || isLoading()"
              [attr.aria-label]="
                isLoading()
                  ? 'Saving education...'
                  : editingId()
                  ? 'Update Education'
                  : 'Create Education'
              "
            >
              {{
                isLoading()
                  ? "Saving..."
                  : editingId()
                  ? "Update Education"
                  : "Create Education"
              }}
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- Education Selection Modal - FIXED: No backdrop close -->
    <div
      *ngIf="showEducationSelectionModal() && isAdmin()"
      class="modal-overlay"
      role="dialog"
      aria-modal="true"
      aria-labelledby="selection-title"
    >
      <div class="education-selection-container" (click)="$event.stopPropagation()">
        <div class="form-header">
          <h3 id="selection-title">Select Education to {{ selectedOperation() | titlecase }}</h3>
          <button class="close-btn" (click)="closeEducationSelectionModal()">
            ×
          </button>
        </div>

        <div class="modal-content">
          <p *ngIf="educations().length === 0">No educations found.</p>
          <div *ngIf="educations().length > 0" class="education-selection-list">
            <button
              *ngFor="let edu of educations(); trackBy: trackByEducationId"
              class="education-selection-item"
              [class.delete-mode]="selectedOperation() === 'delete'"
              (click)="selectEducation(edu.id)"
            >
              <div class="education-info-modal">
                <h4>{{ edu.degree }}</h4>
                <p>{{ edu.institute }}</p>
                <small>{{ edu.startDate }} - {{ edu.currentStudying ? 'Present' : edu.endDate }}</small>
              </div>
              <i
                class="fas"
                [class.fa-edit]="selectedOperation() === 'update'"
                [class.fa-trash-alt]="selectedOperation() === 'delete'"
              ></i>
            </button>
          </div>
        </div>

        <div class="modal-actions">
          <button class="btn-cancel" (click)="closeEducationSelectionModal()">
            Cancel
          </button>
        </div>
      </div>
    </div>

    <!-- Education Details Modal - FIXED: No backdrop close -->
    <div
      *ngIf="showEducationDetails()"
      class="education-details-modal"
      role="dialog"
      aria-modal="true"
      aria-labelledby="education-details-title"
    >
      <div class="education-details-container" (click)="$event.stopPropagation()">
        <!-- Modal Header -->
        <div class="modal-header">
          <div class="modal-header-content">
            <h2 id="education-details-title" class="modal-title">
              {{ selectedEducation()?.degree }}
            </h2>
            <button
              class="modal-close-btn"
              (click)="closeEducationDetails()"
              aria-label="Close education details"
              type="button"
            >
              <i class="fas fa-times" aria-hidden="true"></i>
            </button>
          </div>
        </div>

        <!-- Scrollable Modal Content -->
        <div class="modal-body">
          <div class="modal-content-scroll">
            <!-- Education Details Grid -->
            <div class="modal-section">
              <h3 class="modal-section-title">
                <i class="fas fa-info-circle" aria-hidden="true"></i>
                Education Details
              </h3>
              <div class="education-details-grid">
                <div class="education-detail-item">
                  <div class="education-detail-label">Institute</div>
                  <div class="education-detail-value">{{ selectedEducation()?.institute }}</div>
                </div>
                <div class="education-detail-item">
                  <div class="education-detail-label">University/Board</div>
                  <div class="education-detail-value">{{ selectedEducation()?.university }}</div>
                </div>
                <div class="education-detail-item" *ngIf="selectedEducation()?.location">
                  <div class="education-detail-label">Location</div>
                  <div class="education-detail-value">{{ selectedEducation()?.location }}</div>
                </div>
                <div class="education-detail-item">
                  <div class="education-detail-label">Education Type</div>
                  <div class="education-detail-value">{{ selectedEducation()?.educationType }}</div>
                </div>
                <div class="education-detail-item">
                  <div class="education-detail-label">Duration</div>
                  <div class="education-detail-value">
                    {{ selectedEducation()?.startDate }} - 
                    {{ selectedEducation()?.currentStudying ? 'Present' : selectedEducation()?.endDate }}
                  </div>
                </div>
                <div class="education-detail-item">
                  <div class="education-detail-label">Grade</div>
                  <div class="education-detail-value">{{ selectedEducation()?.grade }}</div>
                </div>
              </div>
            </div>

            <!-- Education Description Section -->
            <div class="modal-section" *ngIf="selectedEducation()?.description">
              <h3 class="modal-section-title">
                <i class="fas fa-book" aria-hidden="true"></i>
                Description
              </h3>
              <div
                class="education-full-description"
                role="article"
                [attr.aria-label]="
                  'Description of ' + selectedEducation()?.degree
                "
              >
                {{ selectedEducation()?.description }}
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Simple Grid Educations Layout -->
    <div *ngIf="!isLoading()" class="educations-container">
      <!-- No Educations Message -->
      <div *ngIf="educations().length === 0" class="no-educations" role="status">
        <p>No educations found.</p>
      </div>

      <!-- Educations Grid -->
      <div
        *ngIf="educations().length > 0"
        class="educations-grid"
        role="main"
        aria-label="Educations grid"
      >
        <div
          *ngFor="let edu of educations(); trackBy: trackByEducationId"
          class="education-card"
          role="listitem"
          [attr.data-education-id]="edu.id"
          [attr.aria-label]="'Education: ' + edu.degree"
        >
          <div class="card-header">
            <div class="education-info">
              <h3
                class="education-degree"
                [id]="'education-degree-' + edu.id"
              >
                {{ edu.degree }}
              </h3>
              <div class="education-institute">
                {{ edu.institute }}
              </div>
              <div class="education-location" *ngIf="edu.location">
                <i class="fas fa-map-marker-alt" aria-hidden="true"></i>
                {{ edu.location }}
              </div>
              <div class="education-dates">
                {{ edu.startDate }} - {{ edu.currentStudying ? 'Present' : edu.endDate }}
              </div>
            </div>

            <!-- Admin Actions -->
            <div *ngIf="isAdmin()" class="admin-actions-card">
              <button
                class="action-btn edit-btn"
                (click)="openForm(edu)"
                title="Edit Education"
                aria-label="Edit education"
              >
                ✏️
              </button>
              <button
                class="action-btn delete-btn"
                (click)="deleteEducation(edu.id, edu.degree)"
                title="Delete Education"
                aria-label="Delete education"
              >
                🗑️
              </button>
            </div>
          </div>

          <div class="card-body">
            <!-- Education Details -->
            <div class="education-details">
              <div class="education-field">
                <strong>{{ edu.field }}</strong>
              </div>
              <div class="education-grade">
                {{ edu.grade }}
              </div>
              <div class="education-status" [class.current]="edu.currentStudying" [class.completed]="!edu.currentStudying">
                <i class="fas" [class.fa-clock]="edu.currentStudying" [class.fa-check-circle]="!edu.currentStudying" aria-hidden="true"></i>
                {{ edu.currentStudying ? 'Currently Studying' : 'Completed' }}
              </div>
            </div>

            <!-- Know More Button -->
            <button
              class="know-more-btn"
              (click)="openEducationDetails(edu)"
              type="button"
              [attr.aria-label]="'Learn more about ' + edu.degree"
            >
              <span>Know More</span>
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
</section>

<!-- Additional accessibility improvements -->
<div class="sr-only" aria-live="polite" aria-atomic="true">
  <span *ngIf="isLoading()">Loading educations, please wait...</span>
  <span *ngIf="!isLoading() && educations().length === 0">
    No educations available to display.
  </span>
  <span *ngIf="!isLoading() && educations().length > 0">
    {{ educations().length }} education{{ educations().length === 1 ? "" : "s" }}
    loaded successfully.
  </span>
  <span *ngIf="showEducationDetails() && selectedEducation()">
    Education details for {{ selectedEducation()?.degree }} are now displayed in a modal.
  </span>
</div>

<!-- Enhanced keyboard navigation support -->
<style>
  /* Focus styles for better accessibility */
  .education-card:focus-within {
    outline: 2px solid #6c757d;
    outline-offset: 2px;
  }

  .know-more-btn:focus,
  .action-btn:focus,
  .modal-close-btn:focus {
    outline: 2px solid #6c757d;
    outline-offset: 2px;
  }

  /* Screen reader only content */
  .sr-only {
    position: absolute;
    width: 1px;
    height: 1px;
    padding: 0;
    margin: -1px;
    overflow: hidden;
    clip: rect(0, 0, 0, 0);
    white-space: nowrap;
    border: 0;
  }

  /* Reduced motion support */
  @media (prefers-reduced-motion: reduce) {
    .educations-grid,
    .education-card,
    .know-more-btn,
    .education-details-modal,
    .education-details-container,
    .modal-header::before {
      transition: none !important;
      animation: none !important;
    }
  }

  /* High contrast mode support */
  @media (prefers-contrast: high) {
    .education-card,
    .education-details-container {
      border: 2px solid currentColor !important;
    }

    .know-more-btn {
      border: 1px solid currentColor !important;
    }
  }
</style>