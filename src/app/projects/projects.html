<section id="projects" class="projects-section">
  <div class="container">
    <!-- Section Header -->
    <div class="section-header">
      <h2 class="section-title">Projects</h2>
    </div>

    <!-- Loading State -->
    <div
      *ngIf="isLoading()"
      class="loading-spinner"
      role="status"
      aria-label="Loading projects"
    >
      <div class="spinner"></div>
      <p>Loading projects...</p>
    </div>

    <!-- Project Form Modal - FIXED: No backdrop close -->
    <div
      *ngIf="showForm() && isAdmin()"
      class="modal-overlay"
      role="dialog"
      aria-modal="true"
      aria-labelledby="form-title"
    >
      <div class="project-form-container" (click)="$event.stopPropagation()">
        <div class="form-header">
          <h3 id="form-title">
            {{ editingId() ? "Edit Project" : "Add New Project" }}
          </h3>
          <button
            class="close-btn"
            (click)="closeForm()"
            aria-label="Close form"
            type="button"
          >
            Ã—
          </button>
        </div>

        <form
          [formGroup]="projectForm"
          (ngSubmit)="onSubmit()"
          class="project-form"
          novalidate
        >
          <div class="form-row">
            <div class="form-group">
              <label for="title">Project Title *</label>
              <input
                type="text"
                id="title"
                formControlName="title"
                placeholder="Enter project title"
                maxlength="400"
                aria-describedby="title-error"
                [attr.aria-invalid]="
                  projectForm.get('title')?.invalid &&
                  projectForm.get('title')?.touched
                "
              />
              <div
                id="title-error"
                *ngIf="
                  projectForm.get('title')?.invalid &&
                  projectForm.get('title')?.touched
                "
                class="error-message"
                role="alert"
              >
                <span *ngIf="projectForm.get('title')?.errors?.['required']"
                  >Project title is required</span
                >
                <span *ngIf="projectForm.get('title')?.errors?.['maxlength']"
                  >Title cannot exceed 400 characters</span
                >
              </div>
            </div>

            <div class="form-group">
              <label for="techStack">Tech Stack</label>
              <input
                type="text"
                id="techStack"
                formControlName="techStack"
                placeholder="e.g., Angular, Spring Boot, MySQL"
                aria-describedby="tech-stack-help"
              />
              <div id="tech-stack-help" class="github-help-text">
                List the main technologies used in this project
              </div>
            </div>
          </div>

          <!-- Rich Text Editor for Description -->
          <div class="form-group full-width">
            <label for="description">Description *</label>

            <!-- Quill Editor Container -->
            <div
              class="quill-editor-container"
              role="textbox"
              aria-multiline="true"
            >
              <div
                #quillEditor
                class="quill-editor"
                aria-label="Project description editor"
              ></div>
            </div>

            <!-- Fallback textarea (hidden by default) -->
            <textarea
              id="description-fallback"
              formControlName="description"
              placeholder="Describe your project, its features, and implementation details"
              rows="6"
              style="display: none"
              aria-describedby="description-help description-error"
              [attr.aria-invalid]="
                projectForm.get('description')?.invalid &&
                projectForm.get('description')?.touched
              "
            ></textarea>

            <div
              id="description-error"
              *ngIf="
                projectForm.get('description')?.invalid &&
                projectForm.get('description')?.touched
              "
              class="error-message"
              role="alert"
            >
              Description is required
            </div>

            <!-- Helper text -->
            <div id="description-help" class="editor-help-text">
              Use the toolbar above to format your text with bold, italic,
              lists, and more. Be detailed about your project's features and
              implementation.
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label for="githubLink">GitHub Link(s)</label>
              <input
                type="text"
                id="githubLink"
                formControlName="githubLink"
                placeholder="https://github.com/user/repo1, https://github.com/user/repo2"
                aria-describedby="github-help github-error"
                [attr.aria-invalid]="
                  projectForm.get('githubLink')?.invalid &&
                  projectForm.get('githubLink')?.touched
                "
              />
              <div
                id="github-error"
                *ngIf="
                  projectForm.get('githubLink')?.invalid &&
                  projectForm.get('githubLink')?.touched
                "
                class="error-message"
                role="alert"
              >
                Please enter valid URL(s)
              </div>
              <div id="github-help" class="github-help-text">
                You can enter multiple repository URLs separated by commas
              </div>
            </div>

            <div class="form-group">
              <label for="liveDemoLink">Live Demo Link</label>
              <input
                type="url"
                id="liveDemoLink"
                formControlName="liveDemoLink"
                placeholder="https://yourproject.com"
                aria-describedby="demo-help demo-error"
                [attr.aria-invalid]="
                  projectForm.get('liveDemoLink')?.invalid &&
                  projectForm.get('liveDemoLink')?.touched
                "
              />
              <div
                id="demo-error"
                *ngIf="
                  projectForm.get('liveDemoLink')?.invalid &&
                  projectForm.get('liveDemoLink')?.touched
                "
                class="error-message"
                role="alert"
              >
                Please enter a valid URL
              </div>
              <div id="demo-help" class="github-help-text">
                Link to your deployed application or demo
              </div>
            </div>
          </div>

          <div class="form-actions">
            <button
              type="button"
              class="btn-cancel"
              (click)="closeForm()"
              aria-label="Cancel form"
            >
              Cancel
            </button>
            <button
              type="submit"
              class="btn-submit"
              [disabled]="!isFormValid || isLoading()"
              [attr.aria-label]="
                isLoading()
                  ? 'Saving project...'
                  : editingId()
                  ? 'Update Project'
                  : 'Create Project'
              "
            >
              {{
                isLoading()
                  ? "Saving..."
                  : editingId()
                  ? "Update Project"
                  : "Create Project"
              }}
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- GitHub Repositories Modal - FIXED: No backdrop close -->
    <div
      *ngIf="showGithubRepos()"
      class="github-repos-modal"
      role="dialog"
      aria-modal="true"
      aria-labelledby="repos-title"
    >
      <div class="github-repos-container" (click)="$event.stopPropagation()">
        <div class="repos-header">
          <h3 id="repos-title">Choose Repository</h3>
        </div>

        <div class="repos-list" role="list">
          <a
            *ngFor="let repo of currentGithubRepos(); let i = index"
            [href]="repo.url"
            target="_blank"
            rel="noopener noreferrer"
            class="repo-item"
            role="listitem"
            [attr.aria-label]="'Open repository: ' + repo.name"
            (click)="closeGithubRepos()"
          >
            <i class="fab fa-github" aria-hidden="true"></i>
            <span>{{ repo.name || "Repository " + (i + 1) }}</span>
          </a>
        </div>

        <div class="repos-close">
          <button
            class="repos-close-btn"
            (click)="closeGithubRepos()"
            aria-label="Close repository list"
          >
            Close
          </button>
        </div>
      </div>
    </div>

    <!-- Project Details Modal - FIXED: No backdrop close -->
    <div
      *ngIf="showProjectDetails()"
      class="project-details-modal"
      role="dialog"
      aria-modal="true"
      aria-labelledby="project-details-title"
    >
      <div class="project-details-container" (click)="$event.stopPropagation()">
        <!-- Modal Header -->
        <div class="modal-header">
          <div class="modal-header-content">
            <h2 id="project-details-title" class="modal-title">
              {{ selectedProject()?.title }}
            </h2>
            <button
              class="modal-close-btn"
              (click)="closeProjectDetails()"
              aria-label="Close project details"
              type="button"
            >
              <i class="fas fa-times" aria-hidden="true"></i>
            </button>
          </div>
        </div>

        <!-- Scrollable Modal Content -->
        <div class="modal-body">
          <div class="modal-content-scroll">
            <!-- Project Description Section -->
            <div class="modal-section">
              <h3 class="modal-section-title">
                <i class="fas fa-info-circle" aria-hidden="true"></i>
                Project Details
              </h3>
              <div
                class="project-full-description"
                [innerHTML]="selectedProject()?.description | safeHtml"
                role="article"
                [attr.aria-label]="
                  'Full description of ' + selectedProject()?.title
                "
              ></div>
            </div>

            <!-- Tech Stack Section -->
            <div class="modal-section" *ngIf="selectedProject()?.techStack">
              <h3 class="modal-section-title">
                <i class="fas fa-tools" aria-hidden="true"></i>
                Technology Stack
              </h3>
              <div class="modal-tech-stack">
                <p
                  class="modal-tech-stack-content"
                  [attr.aria-label]="
                    'Technologies used: ' + selectedProject()?.techStack
                  "
                >
                  {{ selectedProject()?.techStack }}
                </p>
              </div>
            </div>

            <!-- Project Links Section -->
            <div
              class="modal-section"
              *ngIf="
                selectedProject()?.githubLink || selectedProject()?.liveDemoLink
              "
            >
              <h3 class="modal-section-title">
                <i class="fas fa-external-link-alt" aria-hidden="true"></i>
                Project Links
              </h3>
              <div class="modal-project-links">
                <!-- GitHub Links -->
                <ng-container *ngIf="selectedProject()?.githubLink">
                  <!-- Single GitHub repo -->
                  <a
                    *ngIf="
                      !hasMultipleGithubRepos(selectedProject()?.githubLink!)
                    "
                    [href]="selectedProject()?.githubLink"
                    target="_blank"
                    rel="noopener noreferrer"
                    class="modal-project-link modal-github-link"
                    [attr.aria-label]="
                      'View source code for ' +
                      selectedProject()?.title +
                      ' on GitHub'
                    "
                  >
                    <i class="fab fa-github" aria-hidden="true"></i>
                    <span>View on GitHub</span>
                  </a>

                  <!-- Multiple GitHub repos -->
                  <button
                    *ngIf="
                      hasMultipleGithubRepos(selectedProject()?.githubLink!)
                    "
                    class="modal-project-link modal-github-link"
                    (click)="openGithubRepos(selectedProject()?.githubLink!)"
                    type="button"
                    [attr.aria-label]="
                      'View ' +
                      getGithubRepoCount(selectedProject()?.githubLink!) +
                      ' repositories for ' +
                      selectedProject()?.title
                    "
                  >
                    <i class="fab fa-github" aria-hidden="true"></i>
                    <span
                      >GitHub Repos ({{
                        getGithubRepoCount(selectedProject()?.githubLink!)
                      }})</span
                    >
                  </button>
                </ng-container>

                <!-- Live Demo Link -->
                <a
                  *ngIf="selectedProject()?.liveDemoLink"
                  [href]="selectedProject()?.liveDemoLink"
                  target="_blank"
                  rel="noopener noreferrer"
                  class="modal-project-link modal-demo-link"
                  [attr.aria-label]="
                    'View live demo of ' + selectedProject()?.title
                  "
                >
                  <i class="fas fa-external-link-alt" aria-hidden="true"></i>
                  <span>Live Demo</span>
                </a>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Simple Grid Projects Layout -->
    <div *ngIf="!isLoading()" class="projects-container">
      <!-- No Projects Message -->
      <div *ngIf="projects().length === 0" class="no-projects" role="status">
        <p>No projects found.</p>
      </div>

      <!-- Projects Grid -->
      <div
        *ngIf="projects().length > 0"
        class="projects-grid"
        role="main"
        aria-label="Projects grid"
      >
        <div
          *ngFor="let project of projects(); trackBy: trackByProjectId"
          class="project-card"
          role="listitem"
          [attr.data-project-id]="project.id"
          [attr.aria-label]="'Project: ' + project.title"
        >
          <div class="card-header">
            <div class="project-info">
              <h3 class="project-title" [id]="'project-title-' + project.id">
                {{ project.title }}
              </h3>
            </div>
          </div>

          <div class="card-body">
            <!-- Project Description Preview -->
            <div
              class="description-preview"
              [innerHTML]="
                getDescriptionPreview(project.description) | safeHtml
              "
              [attr.aria-labelledby]="'project-title-' + project.id"
              role="region"
            ></div>

            <!-- Know More Button -->
            <button
              class="know-more-btn"
              (click)="openProjectDetails(project)"
              type="button"
              [attr.aria-label]="'Learn more about ' + project.title"
            >
              <i class="fas fa-arrow-right" aria-hidden="true"></i>
              <span>Know More</span>
            </button>

            <!-- Tech Stack -->
            <div
              class="tech-stack-section"
              *ngIf="project.techStack"
              role="complementary"
            >
              <strong>Tech Stack:</strong>
              <div
                class="tech-stack"
                [attr.aria-label]="'Technologies used: ' + project.techStack"
              >
                {{ project.techStack }}
              </div>
            </div>

            <!-- Project Links -->
            <div
              class="project-links"
              role="navigation"
              aria-label="Project links"
            >
              <!-- GitHub Link - Always show -->
              <ng-container *ngIf="project.githubLink; else noGithub">
                <!-- Single GitHub repo -->
                <a
                  *ngIf="!hasMultipleGithubRepos(project.githubLink)"
                  [href]="project.githubLink"
                  target="_blank"
                  rel="noopener noreferrer"
                  class="project-link github-link"
                  [attr.aria-label]="
                    'View source code for ' + project.title + ' on GitHub'
                  "
                >
                  <i class="fab fa-github" aria-hidden="true"></i>
                  <span>GitHub</span>
                </a>

                <!-- Multiple GitHub repos -->
                <button
                  *ngIf="hasMultipleGithubRepos(project.githubLink)"
                  class="project-link github-link"
                  (click)="openGithubRepos(project.githubLink)"
                  type="button"
                  [attr.aria-label]="
                    'View ' +
                    getGithubRepoCount(project.githubLink) +
                    ' repositories for ' +
                    project.title
                  "
                >
                  <i class="fab fa-github" aria-hidden="true"></i>
                  <span
                    >GitHub ({{ getGithubRepoCount(project.githubLink) }})</span
                  >
                </button>
              </ng-container>

              <!-- No GitHub Link -->
              <ng-template #noGithub>
                <span class="project-link github-link disabled-link">
                  <i class="fab fa-github" aria-hidden="true"></i>
                  <span>GitHub</span>
                </span>
              </ng-template>

              <!-- Live Demo Link - Always show -->
              <ng-container *ngIf="project.liveDemoLink; else noDemo">
                <a
                  [href]="project.liveDemoLink"
                  target="_blank"
                  rel="noopener noreferrer"
                  class="project-link demo-link"
                  [attr.aria-label]="'View live demo of ' + project.title"
                >
                  <i class="fas fa-external-link-alt" aria-hidden="true"></i>
                  <span>Live Demo</span>
                </a>
              </ng-container>

              <!-- No Demo Link -->
              <ng-template #noDemo>
                <span class="project-link demo-link disabled-link">
                  <i class="fas fa-external-link-alt" aria-hidden="true"></i>
                  <span>Live Demo</span>
                </span>
              </ng-template>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</section>

<!-- Additional accessibility improvements -->
<div class="sr-only" aria-live="polite" aria-atomic="true">
  <span *ngIf="isLoading()">Loading projects, please wait...</span>
  <span *ngIf="!isLoading() && projects().length === 0"
    >No projects available to display.</span
  >
  <span *ngIf="!isLoading() && projects().length > 0">
    {{ projects().length }} project{{ projects().length === 1 ? "" : "s" }}
    loaded successfully.
  </span>
  <span *ngIf="showProjectDetails() && selectedProject()">
    Project details for {{ selectedProject()?.title }} are now displayed in a
    modal.
  </span>
</div>

<!-- Enhanced keyboard navigation support -->
<style>
  /* Focus styles for better accessibility */
  .project-card:focus-within {
    outline: 2px solid #007bff;
    outline-offset: 2px;
  }

  .know-more-btn:focus,
  .project-link:focus,
  .modal-close-btn:focus,
  .modal-project-link:focus {
    outline: 2px solid #007bff;
    outline-offset: 2px;
  }

  /* Screen reader only content */
  .sr-only {
    position: absolute;
    width: 1px;
    height: 1px;
    padding: 0;
    margin: -1px;
    overflow: hidden;
    clip: rect(0, 0, 0, 0);
    white-space: nowrap;
    border: 0;
  }

  /* Reduced motion support */
  @media (prefers-reduced-motion: reduce) {
    .projects-grid,
    .project-card,
    .know-more-btn,
    .project-details-modal,
    .project-details-container,
    .modal-header::before {
      transition: none !important;
      animation: none !important;
    }
  }

  /* High contrast mode support */
  @media (prefers-contrast: high) {
    .project-card,
    .project-details-container {
      border: 2px solid currentColor !important;
    }

    .project-link,
    .know-more-btn {
      border: 1px solid currentColor !important;
    }
  }
</style>
