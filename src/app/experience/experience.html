<section id="experience" class="experience-section">
  <div class="container">
    <!-- Section Header - Admin controls removed -->
    <div class="section-header">
      <h2 class="section-title">Experience</h2>
    </div>

    <!-- Loading State -->
    <div *ngIf="isLoading()" class="loading-spinner">
      <div class="spinner"></div>
      <p>Loading experiences...</p>
    </div>

    <!-- Experience Form Modal - FIXED: No backdrop close -->
    <div *ngIf="showForm() && isAdmin()" class="modal-overlay">
      <div class="experience-form-container" (click)="$event.stopPropagation()">
        <div class="form-header">
          <h3>{{ editingId() ? 'Edit Experience' : 'Add New Experience' }}</h3>
          <button class="close-btn" (click)="closeForm()">√ó</button>
        </div>

        <form [formGroup]="experienceForm" (ngSubmit)="onSubmit()" class="experience-form">
          <div class="form-row">
            <div class="form-group">
              <label for="companyName">Company Name *</label>
              <input 
                type="text" 
                id="companyName" 
                formControlName="companyName"
                placeholder="Enter company name">
              <div *ngIf="experienceForm.get('companyName')?.invalid && experienceForm.get('companyName')?.touched" class="error-message">
                Company name is required
              </div>
            </div>

            <div class="form-group">
              <label for="role">Role *</label>
              <input 
                type="text" 
                id="role" 
                formControlName="role"
                placeholder="Enter your role">
              <div *ngIf="experienceForm.get('role')?.invalid && experienceForm.get('role')?.touched" class="error-message">
                Role is required
              </div>
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label for="startDate">Start Date *</label>
              <input 
                type="date" 
                id="startDate" 
                formControlName="startDate">
              <div *ngIf="experienceForm.get('startDate')?.invalid && experienceForm.get('startDate')?.touched" class="error-message">
                Start date is required
              </div>
            </div>

            <div class="form-group">
              <label class="checkbox-label">
                <input type="checkbox" formControlName="current" (change)="onCurrentChange()"> Currently Working
              </label>
            </div>
          </div>

          <div class="form-group" *ngIf="!experienceForm.get('current')?.value">
            <label for="endDate">End Date *</label>
            <input 
              type="date" 
              id="endDate" 
              formControlName="endDate">
            <div *ngIf="!experienceForm.get('current')?.value && experienceForm.get('endDate')?.invalid && experienceForm.get('endDate')?.touched" class="error-message">
              End date is required when not currently working
            </div>
          </div>

          <!-- Rich Text Editor for Description -->
          <div class="form-group">
            <label for="description">Description *</label>
            
            <!-- Quill Editor Container -->
            <div class="quill-editor-container">
              <div #quillEditor class="quill-editor"></div>
            </div>
            
            <!-- Fallback textarea (hidden by default) -->
            <textarea 
              id="description-fallback" 
              formControlName="description"
              placeholder="Describe your role and responsibilities"
              rows="4"
              style="display: none;"></textarea>
              
            <div *ngIf="experienceForm.get('description')?.invalid && experienceForm.get('description')?.touched" class="error-message">
              Description is required
            </div>
            
            <!-- Helper text -->
            <div class="editor-help-text">
              Use the toolbar above to format your text with bold, italic, lists, and more.
            </div>
          </div>

          <div class="form-group">
            <label>Skills *</label>
            <div class="skills-container" formArrayName="skills">
              <div *ngFor="let skill of skillsArray.controls; let i = index" class="skill-input">
                <input 
                  type="text" 
                  [formControlName]="i"
                  placeholder="Enter skill">
                <button 
                  type="button" 
                  class="remove-skill-btn" 
                  (click)="removeSkill(i)" 
                  *ngIf="skillsArray.length > 1"
                  title="Remove skill">
                  <i class="fas fa-minus"></i>
                </button>
              </div>
              <button type="button" class="add-skill-btn" (click)="addSkill()">
                <i class="fas fa-plus"></i> Add Skill
              </button>
            </div>
            <div *ngIf="shouldShowSkillsError()" class="error-message">
              At least one valid skill is required
            </div>
          </div>

          <div class="form-actions">
            <button type="button" class="btn-cancel" (click)="closeForm()">Cancel</button>
            <button 
              type="submit" 
              class="btn-submit" 
              [disabled]="!isFormValid || isLoading()">
              {{ isLoading() ? 'Saving...' : (editingId() ? 'Update Experience' : 'Create Experience') }}
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- Experience Timeline -->
    <div *ngIf="!isLoading()" class="experience-timeline">
      <div *ngIf="experiences().length === 0" class="no-experiences">
        <p>No experience records found.</p>
      </div>

      <div *ngFor="let exp of experiences(); let i = index" class="timeline-item">
        <div class="timeline-marker">
          <div class="timeline-dot" [class.current]="exp.current"></div>
          <div class="timeline-line"></div>
        </div>

        <div class="experience-card">
          <div class="card-header">
            <div class="company-info">
              <h3 class="company-name">{{ exp.companyName }}</h3>
              <h4 class="role-title">{{ exp.role }}</h4>
              <div class="date-range">
                <span>{{ formatDate(exp.startDate) }} - {{ exp.current ? 'Present' : formatDate(exp.endDate!) }}</span>
                <span class="duration">({{ calculateDuration(exp.startDate, exp.endDate, exp.current) }})</span>
              </div>
            </div>
            
            <!-- Admin Actions - Only show when admin mode is enabled -->
            <div *ngIf="isAdmin()" class="admin-actions-card">
              <button class="action-btn edit-btn" (click)="openForm(exp)" title="Edit Experience">
                ‚úèÔ∏è
              </button>
              <button class="action-btn delete-btn" (click)="deleteExperience(exp.id, exp.companyName)" title="Delete Experience">
                üóëÔ∏è
              </button>
            </div>
          </div>

          <div class="card-body">
            <!-- Use SafeHtml pipe to render HTML content safely -->
            <div class="description" [innerHTML]="exp.description | safeHtml"></div>
            
            <div class="skills-section" *ngIf="exp.skills && exp.skills.length > 0">
              <strong>Skills:</strong>
              <div class="skills-list">
                <span *ngFor="let skill of exp.skills" class="skill-tag">{{ skill }}</span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</section>