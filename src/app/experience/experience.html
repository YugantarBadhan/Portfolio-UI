<section id="experience" class="experience-section">
  <div class="container">
    <!-- Section Header -->
    <div class="section-header">
      <h2 class="section-title">Experience</h2>
      
      <!-- Admin Toggle Button -->
      <div class="admin-controls">
        <button 
          class="admin-toggle-btn"
          (click)="toggleAdminMode()"
          [class.active]="isAdmin()">
          {{ isAdmin() ? 'Exit Admin' : 'Admin' }}
        </button>
      </div>
    </div>

    <!-- Loading State -->
    <div *ngIf="isLoading()" class="loading-spinner">
      <div class="spinner"></div>
      <p>Loading experiences...</p>
    </div>

    <!-- Admin Add Button -->
    <div *ngIf="isAdmin() && !showForm()" class="admin-actions">
      <button class="btn-add" (click)="openForm()">
        + Add New Experience
      </button>
    </div>

    <!-- Experience Form Modal -->
    <div *ngIf="showForm() && isAdmin()" class="modal-overlay" (click)="closeFormOnBackdrop($event)">
      <div class="experience-form-container" (click)="$event.stopPropagation()">
        <div class="form-header">
          <h3>{{ editingId() ? 'Edit Experience' : 'Add New Experience' }}</h3>
          <button class="close-btn" (click)="closeForm()">Ã—</button>
        </div>

        <form [formGroup]="experienceForm" (ngSubmit)="onSubmit()" class="experience-form">
          <div class="form-row">
            <div class="form-group">
              <label for="companyName">Company Name *</label>
              <input 
                type="text" 
                id="companyName" 
                formControlName="companyName"
                placeholder="Enter company name"
                (input)="onSkillChange()">
              <div *ngIf="experienceForm.get('companyName')?.invalid && experienceForm.get('companyName')?.touched" class="error-message">
                <span *ngIf="experienceForm.get('companyName')?.errors?.['required']">Company name is required</span>
                <span *ngIf="experienceForm.get('companyName')?.errors?.['minlength']">Company name must be at least 2 characters</span>
              </div>
            </div>

            <div class="form-group">
              <label for="role">Role *</label>
              <input 
                type="text" 
                id="role" 
                formControlName="role"
                placeholder="Enter your role"
                (input)="onSkillChange()">
              <div *ngIf="experienceForm.get('role')?.invalid && experienceForm.get('role')?.touched" class="error-message">
                <span *ngIf="experienceForm.get('role')?.errors?.['required']">Role is required</span>
                <span *ngIf="experienceForm.get('role')?.errors?.['minlength']">Role must be at least 2 characters</span>
              </div>
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label for="startDate">Start Date * (YYYY-MM-DD)</label>
              <input 
                type="date" 
                id="startDate" 
                formControlName="startDate"
                (change)="onSkillChange()"
                placeholder="YYYY-MM-DD">
              <div *ngIf="experienceForm.get('startDate')?.invalid && experienceForm.get('startDate')?.touched" class="error-message">
                Start date is required
              </div>
            </div>

            <div class="form-group">
              <label class="checkbox-label">
                <input type="checkbox" formControlName="current" (change)="onCurrentChange(); onSkillChange()"> Currently Working
              </label>
            </div>
          </div>

          <div class="form-group" *ngIf="!experienceForm.get('current')?.value">
            <label for="endDate">End Date (YYYY-MM-DD)</label>
            <input 
              type="date" 
              id="endDate" 
              formControlName="endDate"
              (change)="onSkillChange()"
              placeholder="YYYY-MM-DD">
            <div *ngIf="!experienceForm.get('current')?.value && experienceForm.get('endDate')?.invalid && experienceForm.get('endDate')?.touched" class="error-message">
              End date is required when not currently working
            </div>
          </div>

          <div class="form-group">
            <label for="description">Description *</label>
            <textarea 
              id="description" 
              formControlName="description"
              placeholder="Describe your role and responsibilities (minimum 10 characters)"
              rows="4"
              (input)="onSkillChange()"></textarea>
            <div *ngIf="experienceForm.get('description')?.invalid && experienceForm.get('description')?.touched" class="error-message">
              <span *ngIf="experienceForm.get('description')?.errors?.['required']">Description is required</span>
              <span *ngIf="experienceForm.get('description')?.errors?.['minlength']">Description must be at least 10 characters</span>
            </div>
          </div>

          <div class="form-group">
            <label>Skills *</label>
            <div class="skills-container">
              <div *ngFor="let skill of skillsArray.controls; let i = index" class="skill-input">
                <input 
                  type="text" 
                  [formControlName]="i"
                  placeholder="Enter skill"
                  (input)="onSkillChange()"
                  (keyup)="onSkillChange()"
                  (blur)="onSkillChange()"
                  (change)="onSkillChange()">
                <button 
                  type="button" 
                  class="remove-skill-btn" 
                  (click)="removeSkill(i); onSkillChange()" 
                  *ngIf="skillsArray.length > 1"
                  title="Remove skill">
                  <i class="fas fa-minus"></i>
                </button>
              </div>
              <button type="button" class="add-skill-btn" (click)="addSkill(); onSkillChange()">
                <i class="fas fa-plus"></i> Add Skill
              </button>
            </div>
            <div *ngIf="shouldShowSkillsError()" class="error-message">
              At least one valid skill is required
            </div>
          </div>

          <div class="form-actions">
            <button type="button" class="btn-cancel" (click)="closeForm()">Cancel</button>
            <button 
              type="submit" 
              class="btn-submit" 
              [disabled]="!isFormValid() || isLoading()">
              {{ isLoading() ? 'Saving...' : (editingId() ? 'Update Experience' : 'Create Experience') }}
            </button>
          </div>
          
          <!-- Debug info (remove in production) -->
          <div style="margin-top: 20px; padding: 10px; background: #f8f9fa; border-radius: 5px; font-size: 12px;">
            <strong>Form Debug Info:</strong><br>
            Form Valid: {{ experienceForm.valid }}<br>
            Custom Valid: {{ isFormValid() }}<br>
            Has Valid Skills: {{ hasValidSkills() }}<br>
            Company: {{ experienceForm.get('companyName')?.valid }} ({{ experienceForm.get('companyName')?.value }})<br>
            Role: {{ experienceForm.get('role')?.valid }} ({{ experienceForm.get('role')?.value }})<br>
            Start Date: {{ experienceForm.get('startDate')?.valid }} ({{ experienceForm.get('startDate')?.value }})<br>
            End Date: {{ experienceForm.get('endDate')?.valid || experienceForm.get('current')?.value }} ({{ experienceForm.get('endDate')?.value }})<br>
            Current: {{ experienceForm.get('current')?.value }}<br>
            Description: {{ experienceForm.get('description')?.valid }} (length: {{ experienceForm.get('description')?.value?.length || 0 }})<br>
            Skills Count: {{ skillsArray.length }}<br>
            Skills Values: <span *ngFor="let skill of skillsArray.controls; let i = index">[{{ i }}]: "{{ skill.value }}" (valid: {{ skill.valid }}) </span><br>
            Skills Array Valid: {{ skillsArray.valid }}
          </div>
        </form>
      </div>
    </div>

    <!-- Experience Timeline -->
    <div *ngIf="!isLoading()" class="experience-timeline">
      <div *ngIf="experiences().length === 0" class="no-experiences">
        <p>No experience records found.</p>
      </div>

      <div *ngFor="let exp of experiences(); let i = index" 
           class="timeline-item" 
           [class.last-item]="isLastExperience(i)">
        <div class="timeline-marker">
          <div class="timeline-dot" [class.current]="exp.current"></div>
          <div class="timeline-line" *ngIf="!isLastExperience(i)"></div>
        </div>

        <div class="experience-card">
          <div class="card-header">
            <div class="company-info">
              <h3 class="company-name">{{ exp.companyName }}</h3>
              <h4 class="role-title">{{ exp.role }}</h4>
              <div class="date-range">
                <span>{{ formatDate(exp.startDate) }} - {{ exp.current ? 'Present' : formatDate(exp.endDate!) }}</span>
                <span class="duration">({{ calculateDuration(exp.startDate, exp.endDate, exp.current) }})</span>
              </div>
            </div>
            
            <!-- Admin Actions -->
            <div *ngIf="isAdmin()" class="admin-actions-card">
              <button class="action-btn edit-btn" (click)="openForm(exp)" title="Edit">
                <i class="fas fa-edit"></i>
              </button>
              <button class="action-btn delete-btn" (click)="deleteExperience(exp.id, exp.companyName)" title="Delete">
                <i class="fas fa-trash"></i>
              </button>
            </div>
          </div>

          <div class="card-body">
            <p class="description">{{ exp.description }}</p>
            
            <div class="skills-section" *ngIf="exp.skills && exp.skills.length > 0">
              <strong>Skills:</strong>
              <div class="skills-list">
                <span *ngFor="let skill of exp.skills" class="skill-tag">{{ skill }}</span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</section>